<ion-header class="ion-no-border">
  <ion-toolbar color="primary">
    <ion-title>
      <div class="header-spread-wrapper">
        <span class="title-text">Messages</span>

        <div
          class="header-avatar-wrapper"
          [class]="userProfile?.vibe"
          (click)="goToProfile()"
        >
          <ion-avatar class="main-avatar">
            @if (userProfile?.avatar_url) {
            <img [src]="userProfile.avatar_url" />
            } @else {
            <div class="initials">{{ getInitials(userProfile?.username) }}</div>
            }
          </ion-avatar>
          <div class="vibe-indicator"></div>
        </div>
      </div>
    </ion-title>
  </ion-toolbar>

  <ion-toolbar color="primary">
    <ion-searchbar
      placeholder="Search @handle"
      (ionInput)="onSearch($event)"
      [debounce]="300"
      animated="true"
      class="custom-search"
    ></ion-searchbar>
  </ion-toolbar>

  <ion-toolbar color="primary" class="dashboard-toolbar">
    <div class="my-stuff-bar header-embedded">
      <div class="stuff-item" (click)="openTodoModal()">
        <div class="icon-circle">
          <ion-icon name="checkbox-outline" style="color: #fdcb6e"></ion-icon>
        </div>
        <span>To-Do</span>
      </div>
      <div class="stuff-item" (click)="openMindMap()">
        <div class="icon-circle">
          <ion-icon
            name="git-network-outline"
            style="color: #6c5ce7"
          ></ion-icon>
        </div>
        <span>Mind Map</span>
      </div>

      <div class="stuff-item" (click)="openMoney()">
        <div class="icon-circle">
          <ion-icon name="cash-outline" style="color: #00b894"></ion-icon>
        </div>
        <span>Money</span>
      </div>

      <div class="stuff-item" (click)="openVault()">
        <div class="icon-circle">
          <ion-icon
            name="lock-closed-outline"
            style="color: #ff7675"
          ></ion-icon>
        </div>
        <span>Vault</span>
      </div>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content>
  @if (searchResults.length > 0) {
  <ion-list-header class="section-title">
    <ion-label>Search Results</ion-label>
  </ion-list-header>
  <ion-list lines="none" class="chat-list-container">
    @for (user of searchResults; track 'search-' + user.id) {
    <ion-item (click)="startChat(user.id)" [button]="true" class="chat-card">
      <div
        slot="start"
        class="header-avatar-wrapper list-avatar"
        [class]="user.vibe || 'good'"
      >
        <ion-avatar class="main-avatar">
          @if (user.avatar_url) {
          <img [src]="user.avatar_url" />
          } @else {
          <div class="initials-avatar">{{ getInitials(user.username) }}</div>
          }
        </ion-avatar>
        <div class="vibe-indicator"></div>
      </div>

      <ion-label>
        <h2>@{{ user.username }}</h2>
        <p>{{ user.isExisting ? 'In your contacts' : 'New Connection' }}</p>
      </ion-label>
      <ion-icon
        slot="end"
        name="chevron-forward-outline"
        color="medium"
      ></ion-icon>
    </ion-item>
    }
  </ion-list>
  }

  <ion-list-header class="section-title">
    <ion-label>Recent Conversations</ion-label>
  </ion-list-header>

  <ion-list lines="none" class="chat-list-container">
    @for (chat of personalChats; track 'chat-' + chat.room_id) {
    <ion-item
      (click)="goToChat(chat)"
      [button]="true"
      detail="false"
      class="chat-card"
    >
      <div
        slot="start"
        class="header-avatar-wrapper list-avatar"
        [class]="chat.profiles?.vibe || 'good'"
      >
        <ion-avatar class="main-avatar">
          @if (chat.profiles?.avatar_url) {
          <img [src]="chat.profiles.avatar_url" />
          } @else {
          <div class="initials-avatar">
            {{ getInitials(chat.profiles?.username) }}
          </div>
          }
        </ion-avatar>
        <div class="vibe-indicator"></div>
      </div>
      <ion-label>
        <div class="chat-label-container">
          <div class="name-row">
            <h2>
              @{{ chat.profiles?.username }} @if (chat.vibeLabel) {
              <span class="vibe-tag" [class]="chat.profiles?.vibe"
                >{{ chat.vibeLabel }}</span
              >
              }
            </h2>
            @if (chat.lastMsgDate && !typingStates[chat.room_id]) {
            <ion-note>{{ chat.lastMsgDate | date:'shortTime' }}</ion-note>
            }
          </div>

          <p class="last-message">
            @if (typingStates[chat.room_id]) {
            <i style="color: var(--ion-color-primary)">typing...</i>
            } @else { {{ chat.lastMsgText }} }
          </p>
        </div>
      </ion-label>
    </ion-item>
    } @empty {
    <div class="ion-padding ion-text-center">
      <p style="color: #888">
        No recent chats yet. Search for a friend to start!
      </p>
    </div>
    }
  </ion-list>

  <ion-modal
    [isOpen]="isTodoModalOpen"
    (didDismiss)="isTodoModalOpen = false"
    [initialBreakpoint]="0.5"
    [breakpoints]="[0, 0.5, 0.9]"
    handleBehavior="cycle"
  >
    <ng-template>
      <div class="modal-wrapper">
        <ion-header class="ion-no-border">
          <ion-toolbar>
            <ion-title>My Schedule ({{ todos.length }})</ion-title>
            <ion-buttons slot="end">
              <ion-button (click)="isTodoModalOpen = false" strong="true"
                >Done</ion-button
              >
            </ion-buttons>
          </ion-toolbar>
        </ion-header>

        <ion-content class="custom-scroll">
          <div class="sticky-input">
            <div class="input-row">
              <ion-item lines="none" class="task-input-item">
                <ion-input
                  placeholder="What's on your mind?"
                  [(ngModel)]="newTask"
                  (keyup.enter)="addNewTask()"
                ></ion-input>

                <ion-datetime-button
                  slot="end"
                  datetime="todo-picker"
                ></ion-datetime-button>
              </ion-item>

              <ion-button
                (click)="addNewTask()"
                class="add-btn-small"
                [disabled]="[null,'',undefined].includes (newTask)"
              >
                <ion-icon name="add-outline"></ion-icon>
              </ion-button>
            </div>
          </div>

          <div class="todo-list-container">
            <ion-list lines="none">
              @for (todo of todos; track todo.id) {
              <ion-item class="todo-item-card">
                <ion-checkbox
                  slot="start"
                  [checked]="todo.is_completed"
                  (ionChange)="toggleTodo(todo)"
                ></ion-checkbox>

                <ion-label [class.done]="todo.is_completed">
                  <h3>{{ todo.task }}</h3>
                  <p>
                    <ion-icon name="time-outline"></ion-icon> {{ todo.due_at |
                    date:'MMM d, h:mm a' }}
                  </p>
                </ion-label>

                <ion-button
                  slot="end"
                  fill="clear"
                  class="delete-btn"
                  (click)="deleteTodo(todo.id)"
                >
                  <ion-icon name="trash-outline"></ion-icon>
                </ion-button>
              </ion-item>
              } @empty {
              <div class="empty-state">
                <ion-icon
                  name="sparkles-outline"
                  style="font-size: 2rem; margin-bottom: 10px"
                ></ion-icon>
                <p>Your schedule is clear for now!</p>
              </div>
              }
            </ion-list>
          </div>
        </ion-content>
      </div>
    </ng-template>
  </ion-modal>
</ion-content>
